<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="./reset.css" type="text/css" />
  <title>攀岩志 - 穿越电波</title>
  <style>
    .pyz-card {
      margin: 50px auto;
      width: 90%;
      background-color: rgb(166, 190, 239);
      position: relative;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      line-height: 1.5;
      padding: 8px;
    }

    #header-title {
      font-weight: bold;
      color: azure;
    }

    #content {
      padding: 10px 8px;
    }

    #footer {
      padding: 0 8px;
      font-size: 12px;
      color: azure;
    }
  </style>
</head>

<body>
  <div class="pyz-card">
    <p class="header">
      <img src="./fengjing.png" width="32" />
      <span id="header-title" style="vertical-align: middle;margin-left: 4px;">穿越电波</span>
    </p>
    <p id="content">
      请稍后，电波解析中...
    </p>
    <p id="footer" style="text-align: right;">
      <span id="footer-txt">星际飞船8051号</span>
      <span style="margin: 0 4px;">·</span>
      <a href="https://doc.weixin.qq.com/forms/AKQAYwcpADkATkAnAbUAIoG5UcNocZR1f"
        style="text-decoration:underline;color:bisque">应答</a>
    </p>
  </div>
  <iframe src="./time.html?link=./team.html" title="攀岩志 - 时间在流逝" frameborder="0" width="100%" height="150"></iframe>
  <script>
    window.onload = function () {
      const params = queryURLParams(location.href)
      try {
        laodData(params.id).then(setDianbo)
      } catch (error) {
        console.debug(error)
      }
    }

    function setDianbo (resp) {
      document.getElementById("content").innerHTML = resp.content
      const when = timeago(resp.date)
      const footerTxt = `${when.indexOf('NaN') === -1 ? when : '未知时间'}来自“${resp.where ? resp.where : '一道风景'}”的电波`
      document.getElementById("footer-txt").innerHTML = footerTxt
    }

    function laodData (id) {
      var head = document.getElementsByTagName('head')[0];
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = './data/' + id + '.js';
      return new Promise((resolve, reject) => {
        if (UrlExists(script.src)) {
          head.appendChild(script);
          script.onload = function () {
            resolve(window.dianbo)
          }
        } else {
          resolve({ content: '解析失败，电波文件不存在', date: '2023/04/15 11:17:07', where: '星际飞船8051号' })
        }
      })
    }

    function queryURLParams (url) {
      let href = decodeURI(url)
      let query = href.substring(href.indexOf('?') + 1);
      let param = query.split("&");
      let obj = {}
      for (var i = 0; i < param.length; i++) {
        let per = param[i].split("=");
        obj[per[0]] = per[1]
      }
      return obj;
    }

    function UrlExists (url) {
      var http = new XMLHttpRequest();
      http.open('HEAD', url, false);
      http.send();
      return http.status != 404;
    }

    function timeago (dateString) {
      var minute = 1000 * 60;
      var hour = minute * 60;
      var day = hour * 24;
      var week = day * 7;
      var halfamonth = day * 15;
      var month = day * 30;
      var now = new Date().getTime();
      var dateTimeStamp = dateString
      console.log(typeof dateString)
      if (typeof dateString === 'string') {
        const temString = dateString + ''
        if (temString.indexOf('-') >= 0) {
          dateTimeStamp = new Date(temString.replace(/-/g, '/')).getTime()
        } else {
          dateTimeStamp = new Date(temString).getTime()
        }
      }
      var diffValue = now - dateTimeStamp;
      if (diffValue < 0) {
        return;
      }
      var minC = diffValue / minute;
      var hourC = diffValue / hour;
      var dayC = diffValue / day;
      var weekC = diffValue / week;
      var monthC = diffValue / month;
      if (monthC >= 1 && monthC <= 3) {
        result = " " + parseInt(monthC) + "月前"
      } else if (weekC >= 1 && weekC <= 3) {
        result = " " + parseInt(weekC) + "周前"
      } else if (dayC >= 1 && dayC <= 6) {
        result = " " + parseInt(dayC) + "天前"
      } else if (hourC >= 1 && hourC <= 23) {
        result = " " + parseInt(hourC) + "小时前"
      } else if (minC >= 1 && minC <= 59) {
        result = " " + parseInt(minC) + "分钟前"
      } else if (diffValue >= 0 && diffValue <= minute) {
        result = "刚刚"
      } else {
        var datetime = new Date();
        datetime.setTime(dateTimeStamp);
        var Nyear = datetime.getFullYear();
        var Nmonth = datetime.getMonth() + 1 < 10 ? "0" + (datetime.getMonth() + 1) : datetime.getMonth() + 1;
        var Ndate = datetime.getDate() < 10 ? "0" + datetime.getDate() : datetime.getDate();
        var Nhour = datetime.getHours() < 10 ? "0" + datetime.getHours() : datetime.getHours();
        var Nminute = datetime.getMinutes() < 10 ? "0" + datetime.getMinutes() : datetime.getMinutes();
        var Nsecond = datetime.getSeconds() < 10 ? "0" + datetime.getSeconds() : datetime.getSeconds();
        result = Nyear + "-" + Nmonth + "-" + Ndate
      }
      return result;
    }
  </script>
</body>

</html>